<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Cleaner and CSV Formatter</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body {
            margin: 20px;
        }
        .container {
            max-width: 900px;
        }
        textarea {
            height: 300px;
            resize: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center my-4">Data Cleaner and CSV Formatter</h1>
        <p class="text-muted text-center">Criado para limpar dados da secretaria de segurança pública de São Paulo. <a href="https://www.ssp.sp.gov.br/estatistica/dados-trimestrais">Exemplo</a>. Paste your raw data and generate a clean, formatted CSV file.</p>

        <div class="mb-3">
            <label for="rawData" class="form-label">Paste Raw Data</label>
            <textarea class="form-control" id="rawData" placeholder="Paste raw data here..."></textarea>
        </div>

        <button class="btn btn-primary w-100" id="convertButton">Clean and Convert to CSV</button>

        <div class="mt-4">
            <h5>Generated CSV Preview</h5>
            <textarea class="form-control" id="csvOutput" readonly></textarea>
        </div>

        <button class="btn btn-success w-100 mt-3" id="downloadButton" disabled>Download CSV</button>
    </div>

    <script>
        document.getElementById('convertButton').addEventListener('click', () => {
            const rawData = document.getElementById('rawData').value.trim();
            if (!rawData) {
                alert("Please paste the raw data first!");
                return;
            }

            const year = 2024;
            const quarter = "Q1";
            const fonte = "DEPARTAMENTO DE POLÍCIA CIVIL E DA POLÍCIA MILITAR";
            const link = "https://www.ssp.sp.gov.br/assets/estatistica/trimestral/arquivos/2024-01.htm";

            // Parse raw data into rows
            const rawLines = rawData.split("\n").map(line => line.trim()).filter(line => line);
            const columns = [
                "year", "quarter", "item", "tipo_ocorrencia", "ocorrencia", "obs", "fonte", "link",
                "data_capital", "data_grandesp", "data_interior", "data_deinter1", "data_deinter2",
                "data_deinter3", "data_deinter4", "data_deinter5", "data_deinter6", "data_deinter7",
                "data_deinter8", "data_deinter9", "data_deinter10", "data_estado"
            ];

            let csvData = [columns]; // Initialize CSV rows with headers
            let currentItem = null;
            let currentTipo = null;

            function parseRow(line) {
                const values = line.split("\t").map(v => v.replace(",", "").trim());
                if (values.length < 15) return null; // Skip incomplete rows
                return [
                    year, quarter, currentItem, currentTipo, values[0], null, fonte, link, ...values.slice(1, 15)
                ];
            }

            rawLines.forEach(line => {
                if (line.startsWith("ITEM")) {
                    currentItem = line.split("\t")[1].trim(); // Capture item
                } else if (line.startsWith("I") || line.startsWith("II") || line.startsWith("III") || line.startsWith("IV") || line.startsWith("V") || line.startsWith("VI") || line.startsWith("VII")) {
                    currentTipo = line.split("\t")[1]?.trim() || null; // Capture type
                } else if (!line.startsWith("\t") && !line.startsWith("Capital") && !line.startsWith("Gde SP")) {
                    const row = parseRow(line);
                    if (row) csvData.push(row);
                }
            });

            // Convert to CSV string
            const csvString = Papa.unparse(csvData);
            document.getElementById('csvOutput').value = csvString;
            document.getElementById('downloadButton').disabled = false;

            // Add download functionality
            document.getElementById('downloadButton').addEventListener('click', () => {
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                saveAs(blob, "formatted_data.csv");
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
